version: '3.9'

services:
  # --- INFRASTRUCTURE SERVICES ---
  
  # RabbitMQ Broker for Data Collection AND Synchronization
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - app-network

  # --- 1. USER DATABASE ---
  user-db:
    image: postgres:15-alpine
    restart: always
    container_name: user_postgres_db
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - user_db_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d users_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- 2. DEVICE DATABASE ---
  device-db:
    image: postgres:15-alpine
    restart: always
    container_name: device_postgres_db
    environment:
      POSTGRES_DB: devices_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - device_db_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d devices_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- 3. CREDENTIAL DATABASE ---
  credential-db:
    image: postgres:15-alpine
    restart: always
    container_name: credential_postgres_db
    environment:
      POSTGRES_DB: credential_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - credential_db_data:/var/lib/postgresql/data
    ports:
      - "5431:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d credential_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
      
  # --- 4. MONITORING DATABASE (New) ---
  monitoring-db:
    image: postgres:15-alpine
    restart: always
    container_name: monitoring_postgres_db
    environment:
      POSTGRES_DB: sensor_db
      POSTGRES_USER: sensor_user
      POSTGRES_PASSWORD: sensor_pass
    volumes:
      - monitoring_db_data:/var/lib/postgresql/data
    ports:
      - "5435:5432" # Default PostgreSQL port
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sensor_user -d sensor_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- MICROSERVICES ---

  # 5. AUTH SERVICE
  auth-service:
    build: ./Auth/demo
    container_name: auth-service
    depends_on:
      credential-db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://credential-db:5432/credential_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-service.rule=Host(`localhost`) && PathPrefix(`/auth`)"
      - "traefik.http.services.auth-service.loadbalancer.server.port=8081"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.auth-service.entrypoints=web"
      - "traefik.http.routers.auth-swagger.rule=Host(`localhost`) && (PathPrefix(`/auth/swagger-ui`) || PathPrefix(`/auth/v3/api-docs`))"
      - "traefik.http.routers.auth-swagger.service=auth-service"
      - "traefik.http.routers.auth-swagger.entrypoints=web"
      - "traefik.http.routers.auth-swagger.middlewares=strip-auth-swagger@docker"
      - "traefik.http.routers.auth-swagger.priority=10"
      
  # 6. USER SERVICE (Producer for USER Sync)
  user-service:
    build:
      context: ./Microservice-user/ds2025_spring_example-main/demo
      dockerfile: ../Dockerfile
    container_name: user_api_service
    depends_on:
      user-db:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/users_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SERVER_PORT: 8080
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=Host(`localhost`) && PathPrefix(`/api/people`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=8080"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.user-service.entrypoints=web"
      - "traefik.http.routers.user-service.middlewares=jwt-val@docker,strip-api@docker"
      - "traefik.http.routers.user-swagger.rule=Host(`localhost`) && (PathPrefix(`/user/swagger-ui`) || PathPrefix(`/user/v3/api-docs`))"
      - "traefik.http.routers.user-swagger.service=user-service"
      - "traefik.http.routers.user-swagger.entrypoints=web"
      - "traefik.http.routers.user-swagger.middlewares=strip-user-swagger@docker"
      - "traefik.http.routers.user-swagger.priority=10"

  # 7. DEVICE SERVICE (Consumer for USER Sync / Producer for DEVICE Sync)
  device-service:
    build:
      context: ./Microservice-device/ds2025_spring_example-main/demo
      dockerfile: ../Dockerfile
    container_name: device_api_service
    depends_on:
      device-db:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://device-db:5432/devices_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SERVER_PORT: 8080
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.device-service.rule=Host(`localhost`) && (PathPrefix(`/api/devices`) || PathPrefix(`/api/users`) || PathPrefix(`/api/device-users`))"
      - "traefik.http.services.device-service.loadbalancer.server.port=8080"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.device-service.entrypoints=web"
      - "traefik.http.routers.device-service.middlewares=jwt-val@docker,strip-api@docker"
      - "traefik.http.routers.device-swagger.rule=Host(`localhost`) && (PathPrefix(`/device/swagger-ui`) || PathPrefix(`/device/v3/api-docs`))"
      - "traefik.http.routers.device-swagger.service=device-service"
      - "traefik.http.routers.device-swagger.entrypoints=web"
      - "traefik.http.routers.device-swagger.middlewares=strip-device-swagger@docker"
      - "traefik.http.routers.device-swagger.priority=10"

  # 8. SENSOR DATA PRODUCER (New - Simulator)
  sensor-producer:
    build: ./Monitoring-microservice/producer
    container_name: sensor-producer
    depends_on:
      rabbitmq:
        condition: service_started
      # Remove device-service and auth-service dependencies if you wish
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      APP_QUEUE_NAME: sensor.data.queue
      # You can remove AUTH_SERVICE_URL and DEVICE_SERVICE_URL
    networks:
      - app-network

  # 9. MONITORING CONSUMER (New - Aggregation/Sync Consumer & REST API)
  monitoring-consumer:
    build: ./Monitoring-microservice/consumer
    container_name: monitoring-consumer
    depends_on:
      rabbitmq:
        condition: service_started
      monitoring-db:
        condition: service_healthy
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      APP_QUEUE_NAME: sensor.data.queue
      SPRING_DATASOURCE_URL: jdbc:postgresql://monitoring-db:5432/sensor_db
      SPRING_DATASOURCE_USERNAME: sensor_user
      SPRING_DATASOURCE_PASSWORD: sensor_pass
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Route for the Monitoring API endpoint (e.g., /api/monitoring/consumption)
      - "traefik.http.routers.monitoring-service.rule=Host(`localhost`) && PathPrefix(`/api/monitoring`)"
      - "traefik.http.services.monitoring-service.loadbalancer.server.port=8080" 
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.monitoring-service.entrypoints=web"
      - "traefik.http.routers.monitoring-service.middlewares=jwt-val@docker,strip-api@docker" # Applies JWT validation and strips /api
      # Optional: Monitoring Swagger 
      - "traefik.http.routers.monitoring-swagger.rule=Host(`localhost`) && (PathPrefix(`/monitor/swagger-ui`) || PathPrefix(`/monitor/v3/api-docs`))"
      - "traefik.http.routers.monitoring-swagger.service=monitoring-consumer"
      - "traefik.http.routers.monitoring-swagger.entrypoints=web"
      - "traefik.http.routers.monitoring-swagger.middlewares=strip-monitor-swagger@docker"
      - "traefik.http.routers.monitoring-swagger.priority=10"
      
  # 10. TRAEFIK REVERSE PROXY
  reverse-proxy:
    image: traefik:v3.1
    container_name: traefik
    restart: always
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--experimental.plugins.jwtValidation.moduleName=github.com/legege/jwt-validation-middleware"
      - "--experimental.plugins.jwtValidation.version=v0.2.1"
    ports:
      - "8000:80" # Exposed port for client access
      - "8082:8080" # Exposed port for Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_logs:/var/log/traefik
      - ./plugins-storage:/plugins-storage
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Strip API middleware definitions
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.strip-auth-swagger.stripprefix.prefixes=/auth"
      - "traefik.http.middlewares.strip-user-swagger.stripprefix.prefixes=/user"
      - "traefik.http.middlewares.strip-device-swagger.stripprefix.prefixes=/device"
      - "traefik.http.middlewares.strip-monitor-swagger.stripprefix.prefixes=/monitor" # Added new strip middleware
      # JWT Middleware Definition (remains the same as per previous steps)
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.secret=supersecret123456supersecret123456"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.signingMethod=HS256"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.authHeader=true"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.claims=role"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.requiredClaim.role=ROLE_USER,ROLE_ADMIN"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.payloadHeaders.X-User=sub"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.payloadHeaders.X-Role=role"

  # 11. FRONTEND SERVICE 
  frontend:
    build:
      context: ./react-demo-master
      dockerfile: Dockerfile
    container_name: react-frontend-service
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.frontend-service.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend-service.entrypoints=web"
      - "traefik.http.routers.frontend-service.priority=1"
      - "traefik.http.services.frontend-service.loadbalancer.server.port=80"

volumes:
  user_db_data:
  device_db_data:
  credential_db_data:
  monitoring_db_data: 
  traefik_logs:
  plugins-storage:
  
networks:
  app-network:
    driver: bridge