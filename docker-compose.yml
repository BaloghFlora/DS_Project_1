version: '3.9'

services:
  # --- 1. USER DATABASE ---
  user-db:
    image: postgres:15-alpine
    restart: always
    container_name: user_postgres_db
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - user_db_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d users_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- 2. DEVICE DATABASE ---
  device-db:
    image: postgres:15-alpine
    restart: always
    container_name: device_postgres_db
    environment:
      POSTGRES_DB: devices_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - device_db_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d devices_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- 3. CREDENTIAL DATABASE ---
  credential-db:
    image: postgres:15-alpine
    restart: always
    container_name: credential_postgres_db
    environment:
      POSTGRES_DB: credential_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - credential_db_data:/var/lib/postgresql/data
    ports:
      - "5431:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d credential_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # --- 4. AUTH SERVICE ---
  auth-service:
    build: ./Auth/demo
    container_name: auth-service
    depends_on:
      credential-db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://credential-db:5432/credential_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-service.rule=Host(`localhost`) && PathPrefix(`/auth`)"
      - "traefik.http.services.auth-service.loadbalancer.server.port=8081"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.auth-service.entrypoints=web"
      # --- Router for Swagger (strips /auth prefix) ---
      - "traefik.http.routers.auth-swagger.rule=Host(`localhost`) && (PathPrefix(`/auth/swagger-ui`) || PathPrefix(`/auth/v3/api-docs`))"
      - "traefik.http.routers.auth-swagger.service=auth-service"
      - "traefik.http.routers.auth-swagger.entrypoints=web"
      - "traefik.http.routers.auth-swagger.middlewares=strip-auth-swagger@docker"
      - "traefik.http.routers.auth-swagger.priority=10"
      
  # --- 5. USER SERVICE ---
  user-service:
    build:
      context: ./Microservice-user/ds2025_spring_example-main/demo
      dockerfile: ../Dockerfile
    container_name: user_api_service
    depends_on:
      user-db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/users_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SERVER_PORT: 8080
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=Host(`localhost`) && PathPrefix(`/api/people`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=8080"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.user-service.entrypoints=web"
      - "traefik.http.routers.user-service.middlewares=jwt-val@docker,strip-api@docker"
      # --- Router for Swagger (strips /user prefix) ---
      - "traefik.http.routers.user-swagger.rule=Host(`localhost`) && (PathPrefix(`/user/swagger-ui`) || PathPrefix(`/user/v3/api-docs`))"
      - "traefik.http.routers.user-swagger.service=user-service"
      - "traefik.http.routers.user-swagger.entrypoints=web"
      - "traefik.http.routers.user-swagger.middlewares=strip-user-swagger@docker"
      - "traefik.http.routers.user-swagger.priority=10"

  # --- 6. DEVICE SERVICE ---
  device-service:
    build:
      context: ./Microservice-device/ds2025_spring_example-main/demo
      dockerfile: ../Dockerfile
    container_name: device_api_service
    depends_on:
      device-db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://device-db:5432/devices_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SERVER_PORT: 8080
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.device-service.rule=Host(`localhost`) && (PathPrefix(`/api/devices`) || PathPrefix(`/api/users`) || PathPrefix(`/api/device-users`))"
      - "traefik.http.services.device-service.loadbalancer.server.port=8080"
      - "traefik.docker.network=app-network"
      - "traefik.http.routers.device-service.entrypoints=web"
      - "traefik.http.routers.device-service.middlewares=jwt-val@docker,strip-api@docker"
      # --- Router for Swagger (strips /device prefix) ---
      - "traefik.http.routers.device-swagger.rule=Host(`localhost`) && (PathPrefix(`/device/swagger-ui`) || PathPrefix(`/device/v3/api-docs`))"
      - "traefik.http.routers.device-swagger.service=device-service"
      - "traefik.http.routers.device-swagger.entrypoints=web"
      - "traefik.http.routers.device-swagger.middlewares=strip-device-swagger@docker"
      - "traefik.http.routers.device-swagger.priority=10"

  # --- 7. TRAEFIK REVERSE PROXY ---
  reverse-proxy:
    image: traefik:v3.1
    container_name: traefik
    restart: always
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--experimental.plugins.jwtValidation.moduleName=github.com/legege/jwt-validation-middleware"
      - "--experimental.plugins.jwtValidation.version=v0.2.1"
    ports:
      - "8000:80"
      - "8082:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_logs:/var/log/traefik
      - ./plugins-storage:/plugins-storage
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Strip API middleware
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.strip-auth-swagger.stripprefix.prefixes=/auth"
      # --- SWAGGER MIDDLEWARE (New) ---
      # Defines 3 new middleware, one for each service's swagger
      - "traefik.http.middlewares.strip-auth-swagger.stripprefix.prefixes=/auth"
      - "traefik.http.middlewares.strip-user-swagger.stripprefix.prefixes=/user"
      - "traefik.http.middlewares.strip-device-swagger.stripprefix.prefixes=/device"
      # JWT Middleware Definition
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.secret=supersecret123456supersecret123456"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.signingMethod=HS256"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.authHeader=true"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.claims=role"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.requiredClaim.role=ROLE_USER,ROLE_ADMIN"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.payloadHeaders.X-User=sub"
      - "traefik.http.middlewares.jwt-val.plugin.jwtValidation.payloadHeaders.X-Role=role"

# --- 8. FRONTEND SERVICE (ADDED) ---
  frontend:
    build:
      context: ./react-demo-master
      dockerfile: Dockerfile
    container_name: react-frontend-service
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=app-network"
      # --- Router for the frontend (React App) ---
      - "traefik.http.routers.frontend-service.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend-service.entrypoints=web"
      - "traefik.http.routers.frontend-service.priority=1" # <-- LOWEST priority
      # --- Service definition for the frontend ---
      - "traefik.http.services.frontend-service.loadbalancer.server.port=80" # Nginx serves on port 80

volumes:
  user_db_data:
  device_db_data:
  credential_db_data:
  traefik_logs:
  plugins-storage:
  
# --- NETWORKS ---
networks:
  app-network:
    driver: bridge